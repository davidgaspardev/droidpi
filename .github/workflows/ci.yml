name: Rust CLI CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - develop

jobs:
  test-cli:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - uses: actions/checkout@v3

      # Step 2: Set up rust
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rust-version: stable

      # Step 3: Build CLI
      - name: Build CLI
        run: cargo build --release

      # Step 4: Download icon to use as input
      - name: Download test icon
        run: |
          mkdir -p input
          curl -L -o input/test-icon.png https://firebasestorage.googleapis.com/v0/b/myself-dg.appspot.com/o/my-website%2FoptionalParameters.png?alt=media&token=fe276d41-d20e-4e7f-a13b-7302a1508b2c

      - name: Run CLI tool for Flutter
        run: |
          mkdir -p output/flutter
          ./target/release/droidpi --src input/test-icon.png --outDir output/flutter --platform flutter --name launcher-icon

      - name: Check Flutter output files
        run: |
          count=$(find output/flutter -type f -name "launcher-icon.png" | wc -l)
          echo "Found $count launcher-icon.png files for Flutter"

          if [ "$count" -eq 5 ]; then
            echo "✅ Exactly five launcher-icon.png files found for Flutter"
          else
            echo "❌ Expected 5 launcher-icon.png files for Flutter, found $count"
            exit 1
          fi

          # Check Flutter directory structure
          [ -f "output/flutter/launcher-icon.png" ] && echo "✅ Found mdpi file" || (echo "❌ Missing mdpi file" && exit 1)
          [ -f "output/flutter/1.5x/launcher-icon.png" ] && echo "✅ Found hdpi file" || (echo "❌ Missing hdpi file" && exit 1)
          [ -f "output/flutter/2.0x/launcher-icon.png" ] && echo "✅ Found xhdpi file" || (echo "❌ Missing xhdpi file" && exit 1)
          [ -f "output/flutter/3.0x/launcher-icon.png" ] && echo "✅ Found xxhdpi file" || (echo "❌ Missing xxhdpi file" && exit 1)
          [ -f "output/flutter/4.0x/launcher-icon.png" ] && echo "✅ Found xxxhdpi file" || (echo "❌ Missing xxxhdpi file" && exit 1)

      - name: Run CLI tool for Android
        run: |
          mkdir -p output/android
          ./target/release/droidpi --src input/test-icon.png --outDir output/android --platform android --name launcher-icon

      - name: Check Android output files
        run: |
          count=$(find output/android -type f -name "launcher-icon.png" | wc -l)
          echo "Found $count launcher-icon.png files for Android"

          if [ "$count" -eq 5 ]; then
            echo "✅ Exactly five launcher-icon.png files found for Android"
          else
            echo "❌ Expected 5 launcher-icon.png files for Android, found $count"
            exit 1
          fi

          # Check Android directory structure
          [ -f "output/android/mipmap-mdpi/launcher-icon.png" ] && echo "✅ Found mdpi file" || (echo "❌ Missing mdpi file" && exit 1)
          [ -f "output/android/mipmap-hdpi/launcher-icon.png" ] && echo "✅ Found hdpi file" || (echo "❌ Missing hdpi file" && exit 1)
          [ -f "output/android/mipmap-xhdpi/launcher-icon.png" ] && echo "✅ Found xhdpi file" || (echo "❌ Missing xhdpi file" && exit 1)
          [ -f "output/android/mipmap-xxhdpi/launcher-icon.png" ] && echo "✅ Found xxhdpi file" || (echo "❌ Missing xxhdpi file" && exit 1)
          [ -f "output/android/mipmap-xxxhdpi/launcher-icon.png" ] && echo "✅ Found xxxhdpi file" || (echo "❌ Missing xxxhdpi file" && exit 1)

      - name: Clean output Android
        run: rm -rf output/android

      - name: Run CLI tool for Android (use drawable)
        run: |
          mkdir -p output/android
          ./target/release/droidpi --src input/test-icon.png --outDir output/android --platform android --name launcher-icon --use-drawable

      - name: Check Android output files
        run: |
          count=$(find output/android -type f -name "launcher-icon.png" | wc -l)
          echo "Found $count launcher-icon.png files for Android"

          if [ "$count" -eq 5 ]; then
            echo "✅ Exactly five launcher-icon.png files found for Android"
          else
            echo "❌ Expected 5 launcher-icon.png files for Android, found $count"
            exit 1
          fi

          # Check Android directory structure
          [ -f "output/android/drawable-mdpi/launcher-icon.png" ] && echo "✅ Found mdpi file" || (echo "❌ Missing mdpi file" && exit 1)
          [ -f "output/android/drawable-hdpi/launcher-icon.png" ] && echo "✅ Found hdpi file" || (echo "❌ Missing hdpi file" && exit 1)
          [ -f "output/android/drawable-xhdpi/launcher-icon.png" ] && echo "✅ Found xhdpi file" || (echo "❌ Missing xhdpi file" && exit 1)
          [ -f "output/android/drawable-xxhdpi/launcher-icon.png" ] && echo "✅ Found xxhdpi file" || (echo "❌ Missing xxhdpi file" && exit 1)
          [ -f "output/android/drawable-xxxhdpi/launcher-icon.png" ] && echo "✅ Found xxxhdpi file" || (echo "❌ Missing xxxhdpi file" && exit 1)
